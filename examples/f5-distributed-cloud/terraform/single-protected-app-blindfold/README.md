# Introduction  
This Terraform example uses a bash script to create or update an HTTP Load Balancer with Custom Cetificate using Blindfold secret generated by the vesctl utility (https://docs.cloud.f5.com/docs/how-to/volterra-automation-tools/vesctl).  

## Use cases
- Create an HTTP Load Balancer using an Blindfold Secret based on the private key without exposing it in clear text.  
- Update HTTP Load Balancer expired certificates using blindfold secret.  

## Objects created
    Health check
    Origin Pool  
    App Firewall  
    HTTPS Load Balancer with Custom Certificate an encrypted private key using blindfold  

## Environment praparation 

- Generate the API Certificate and download the certificate in PKCS #12 (P12) format:  
- https://docs.cloud.f5.com/docs/how-to/user-mgmt/credentials/#generate-api-certificate  
  Extract the certificate and key from the .p12 file:  
	openssl pkcs12 -in <filename>.p12 -nodes -nokeys -out certificate.crt  
	openssl pkcs12 -in <filename>.p12 -nodes -nocerts -out private.key  
  Copy the files (.p12,.crt,.key) to certs/ folder  

- Install and configure vesctl utility: https://gitlab.com/volterra.io/vesctl/-/tree/main  

- Create .vesconfig config file in script/ folder with the location of the certificate and api endpoint url:  
  server-urls: https://<tenant_name>.console.ves.volterra.io/api  
  p12-bundle: /path/to/api_credential.p12  

- Download the blindfold script and move it to scrips/ folder.  

- Define the following variables in variables.tf  
    "api_cert" = { default = "./certs/<api credential certificate>.crt" }  
    "api_key" = { default = "./certs/<api credential key>.key" }  
    "api_url" = { default = "https://<tenant_name>.console.ves.volterra.io/api" }  
    "namespace" = { default = <"The namespace where the application will be deployed"> }  
    "app_domain" = { default = <"Application/Load balancer Domain name"> }  
    "origin_server_dns" = { default = <"Public DNS Name of Origin Server"> }  

- Define the password of the API certificate in secret.tfvars:  
  VES_PASSWORD=".p12 password"  

- Copy the application Load Balancer's Certificate and private key in PEM format (Including the PEM headers) to the certs/ folder.  

## Usage   
terraform init  
terraform plan -var="lb_cert=./certs/<http load balancer certificate>" -var="lb_key=./certs/<http load balancer private key>" -var-file="secret.tfvars"  
terraform apply -var="lb_cert=./certs/<http load balancer certificate>" -var="lb_key=./certs/<http load balancer private key>" -var-file="secret.tfvars" --auto-approve  terraform destroy -var="lb_cert=./certs/<http load balancer certificate>" -var="lb_key=./certs/<http load balancer private key>" -var-file="secret.tfvars" --auto-approve

## Notes  
- Optionally, a secure remote location with encryption at rest and access control support can be used to store secret.tfvars and the Terraform state.  
- F5 Distributed Cloud Blindfold reference: https://docs.cloud.f5.com/docs/how-to/advanced-security/blindfold-your-tls-certificates   
